// Datasource & generator (adapter le provider et url selon ton .env)
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  recursive_type_depth = 5
}

//////////////////////////////////////
// ENUMS
//////////////////////////////////////
enum Role {
  STUDENT
  TEACHER
  DEPARTMENT_HEAD
  ADMIN
}

enum AbsenceStatus {
  unjustified
  pending_review
  justified
  approved
  rejected
}

enum RoomType {
  LECTURE
  LAB
  EXAM
  OTHER
}

enum ScheduleStatus {
  PLANNED
  CANCELED
  MAKEUP
}

//////////////////////////////////////
// MODELS
//////////////////////////////////////

model Utilisateur {
  id        String   @id @default(cuid())
  nom       String // lastName
  prenom    String // firstName  
  email     String   @unique
  role      Role
  mdp_hash  String // password hash
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations avec autres modèles (foreign keys)
  enseignant_id String? @unique
  etudiant_id   String? @unique

  enseignant      Enseignant?      @relation("UtilisateurEnseignant", fields: [enseignant_id], references: [id])
  etudiant        Etudiant?        @relation("UtilisateurEtudiant", fields: [etudiant_id], references: [id])
  chefDepartement ChefDepartement?
  administrateur  Administrateur?

  // Relations messages
  messagesEnvoyes Message[] @relation("UtilisateurMessagesEnvoyes")
  messagesRecus   Message[] @relation("UtilisateurMessagesRecus")

  // Relations notifications
  notifications Notification[] @relation("UserNotifications")

  // Relations events
  eventsCreated    Evenement[]      @relation("EventCreator")
  eventComments    EventComment[]   @relation("EventComments")
  eventReactions   EventReaction[]  @relation("EventReactions")

  @@index([role])
  @@index([email])
  @@index([enseignant_id])
  @@index([etudiant_id])
  @@map("User")
}

model Departement {
  id        String   @id @default(cuid())
  nom       String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  specialites     Specialite[]
  enseignants     Enseignant[]
  chefDepartement ChefDepartement?

  @@map("Department")
}

model Specialite {
  id             String   @id @default(cuid())
  nom            String
  id_departement String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  departement Departement @relation(fields: [id_departement], references: [id], onDelete: Cascade)
  niveaux     Niveau[]
  etudiants   Etudiant[]
  matieres    Matiere[]

  @@index([id_departement])
  @@map("Specialty")
}

model Niveau {
  id            String   @id @default(cuid())
  nom           String
  id_specialite String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  specialite Specialite  @relation(fields: [id_specialite], references: [id], onDelete: Cascade)
  groupes    Groupe[]
  etudiants  Etudiant[] // Students in this level

  @@index([id_specialite])
  @@map("Level")
}

model Groupe {
  id        String   @id @default(cuid())
  nom       String
  id_niveau String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  niveau      Niveau        @relation(fields: [id_niveau], references: [id], onDelete: Cascade)
  etudiants   Etudiant[]
  emploiTemps EmploiTemps[]

  @@index([id_niveau])
  @@map("Group")
}

model Salle {
  id        String   @id @default(cuid())
  code      String   @unique
  type      RoomType
  capacite  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emploiTemps EmploiTemps[]

  @@map("Room")
}

model Enseignant {
  id             String   @id @default(cuid())
  nom            String
  prenom         String
  email          String   @unique
  id_departement String
  image_url      String? // Cloudinary image URL
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  departement Departement   @relation(fields: [id_departement], references: [id], onDelete: Cascade)
  matieres    Matiere[]
  emploiTemps EmploiTemps[]

  // Reverse relation to Utilisateur
  utilisateur Utilisateur? @relation("UtilisateurEnseignant")

  // Grading system relation
  notes Note[]

  @@index([id_departement])
  @@index([email])
  @@map("Teacher")
}

model Etudiant {
  id            String   @id @default(cuid())
  nom           String
  prenom        String
  email         String   @unique
  id_groupe     String
  id_specialite String
  id_niveau     String?  // Optional level/year reference
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  groupe     Groupe     @relation(fields: [id_groupe], references: [id], onDelete: Cascade)
  specialite Specialite @relation(fields: [id_specialite], references: [id], onDelete: Cascade)
  niveau     Niveau?    @relation(fields: [id_niveau], references: [id], onDelete: SetNull)
  absences   Absence[]

  // Reverse relation to Utilisateur
  utilisateur Utilisateur? @relation("UtilisateurEtudiant")

  // Grading system relations
  notes       Note[]
  moyennes    Moyenne[]
  releveNotes ReleveNotes[]

  @@index([id_groupe])
  @@index([id_specialite])
  @@index([id_niveau])
  @@index([email])
  @@map("Student")
}

model Matiere {
  id            String   @id @default(cuid())
  nom           String
  coefficient   Float    @default(1.0) // Subject coefficient/weight
  id_specialite String
  id_enseignant String? // Make teacher optional
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  specialite  Specialite    @relation(fields: [id_specialite], references: [id], onDelete: Cascade)
  enseignant  Enseignant?   @relation(fields: [id_enseignant], references: [id], onDelete: SetNull) // Make relation optional
  emploiTemps EmploiTemps[]

  // Grading system relations
  notes    Note[]
  moyennes Moyenne[]

  @@index([id_specialite])
  @@index([id_enseignant])
  @@map("Subject")
}

model EmploiTemps {
  id            String         @id @default(cuid())
  date          DateTime
  heure_debut   DateTime
  heure_fin     DateTime
  id_salle      String
  id_matiere    String
  id_groupe     String
  id_enseignant String
  status        ScheduleStatus @default(PLANNED)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  salle      Salle      @relation(fields: [id_salle], references: [id], onDelete: Restrict)
  matiere    Matiere    @relation(fields: [id_matiere], references: [id], onDelete: Cascade)
  groupe     Groupe     @relation(fields: [id_groupe], references: [id], onDelete: Cascade)
  enseignant Enseignant @relation(fields: [id_enseignant], references: [id], onDelete: Cascade)
  absences   Absence[]

  @@index([date])
  @@index([id_salle])
  @@index([id_enseignant])
  @@index([id_groupe])
  @@map("Schedule")
}

model Absence {
  id                   String        @id @default(cuid())
  id_etudiant          String
  id_emploitemps       String
  motif                String? // reason for absence
  statut               AbsenceStatus @default(unjustified)
  justification_text   String? // student's justification text
  supporting_documents String[]      @default([]) // URLs to supporting documents
  review_notes         String? // department head review notes
  reviewed_at          DateTime? // when it was reviewed
  reviewed_by          String? // who reviewed it (user ID)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  etudiant    Etudiant    @relation(fields: [id_etudiant], references: [id], onDelete: Cascade)
  emploitemps EmploiTemps @relation(fields: [id_emploitemps], references: [id], onDelete: Cascade)

  @@index([id_etudiant])
  @@index([id_emploitemps])
  @@index([statut])
  @@index([createdAt])
}

model ChefDepartement {
  id             String   @id @default(cuid())
  id_utilisateur String   @unique
  id_departement String   @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  utilisateur Utilisateur @relation(fields: [id_utilisateur], references: [id], onDelete: Cascade)
  departement Departement @relation(fields: [id_departement], references: [id], onDelete: Cascade)

  @@index([id_departement])
  @@map("DepartmentHead")
}

model Administrateur {
  id             String   @id @default(cuid())
  id_utilisateur String   @unique
  niveau         String   @default("ADMIN") // SUPER_ADMIN, ADMIN, MODERATOR
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  utilisateur Utilisateur @relation(fields: [id_utilisateur], references: [id], onDelete: Cascade)

  @@index([niveau])
  @@map("Admin")
}

model Message {
  id              String   @id @default(cuid())
  id_expediteur   String
  id_destinataire String
  contenu         String
  createdAt       DateTime @default(now())

  expediteur   Utilisateur @relation("UtilisateurMessagesEnvoyes", fields: [id_expediteur], references: [id], onDelete: Cascade)
  destinataire Utilisateur @relation("UtilisateurMessagesRecus", fields: [id_destinataire], references: [id], onDelete: Cascade)

  @@index([id_expediteur, createdAt])
  @@index([id_destinataire, createdAt])
  @@map("Message")
}

// Notification System
model Notification {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  type        String   // SCHEDULE_CREATED, SCHEDULE_UPDATED, SCHEDULE_DELETED, ABSENCE_MARKED
  title       String
  message     String
  relatedId   String?  @map("related_id") // ID of schedule or absence
  isRead      Boolean  @default(false) @map("is_read")
  createdAt   DateTime @default(now()) @map("created_at")

  user Utilisateur @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// GRADING SYSTEM - Student Averages and Grade Reports
// ============================================================================

enum GradeType {
  EXAM         // Final exam
  CONTINUOUS   // Continuous assessment (DS - Devoir Surveillé)
  PRACTICAL    // Practical work (TP - Travaux Pratiques)
  PROJECT      // Project work
  ORAL         // Oral exam
}

enum SemesterType {
  SEMESTER_1
  SEMESTER_2
}

// Individual grades/notes submitted by teachers
model Note {
  id             String       @id @default(cuid())
  valeur         Float        // Grade value (0-20 scale)
  type           GradeType    // Type of grade
  coefficient    Float        @default(1.0) // Weight of this grade
  id_etudiant    String
  id_matiere     String
  id_enseignant  String
  semestre       SemesterType
  annee_scolaire String       // Academic year (e.g., "2024-2025")
  date_examen    DateTime?    // When the exam/evaluation took place
  validee        Boolean      @default(false) // Whether grade is validated
  observation    String?      // Optional comments
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  etudiant   Etudiant   @relation(fields: [id_etudiant], references: [id], onDelete: Cascade)
  matiere    Matiere    @relation(fields: [id_matiere], references: [id], onDelete: Cascade)
  enseignant Enseignant @relation(fields: [id_enseignant], references: [id], onDelete: Cascade)

  @@index([id_etudiant])
  @@index([id_matiere])
  @@index([id_enseignant])
  @@index([semestre, annee_scolaire])
  @@map("grades")
}

// Calculated averages (moyennes) for students
model Moyenne {
  id                String        @id @default(cuid())
  id_etudiant       String
  id_matiere        String?       // NULL for general average, ID for subject average
  semestre          SemesterType
  annee_scolaire    String
  moyenne_matiere   Float?        // Subject average (if id_matiere is set)
  moyenne_generale  Float?        // General average (if id_matiere is NULL)
  rang              Int?          // Student rank in class/department
  validee           Boolean       @default(false) // Validated by department head
  validee_par       String?       // Who validated (user ID)
  date_validation   DateTime?     // When validated
  observation       String?       // Department head comments
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  etudiant Etudiant @relation(fields: [id_etudiant], references: [id], onDelete: Cascade)
  matiere  Matiere? @relation(fields: [id_matiere], references: [id], onDelete: Cascade)

  @@unique([id_etudiant, id_matiere, semestre, annee_scolaire])
  @@index([id_etudiant])
  @@index([id_matiere])
  @@index([semestre, annee_scolaire])
  @@index([validee])
  @@map("averages")
}

// Grade reports (Relevé de Notes) - Generated documents
model ReleveNotes {
  id               String        @id @default(cuid())
  id_etudiant      String
  semestre         SemesterType
  annee_scolaire   String
  moyenne_generale Float         // General average for the semester
  rang             Int?          // Student rank
  total_etudiants  Int?          // Total students in class/department
  appreciation     String?       // Overall appreciation (Très bien, Bien, etc.)
  pdf_url          String?       // URL to generated PDF
  genere_par       String?       // Who generated the report (user ID)
  date_generation  DateTime      @default(now())
  envoye           Boolean       @default(false) // Whether report was sent
  date_envoi       DateTime?     // When the report was sent
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  etudiant Etudiant @relation(fields: [id_etudiant], references: [id], onDelete: Cascade)

  @@unique([id_etudiant, semestre, annee_scolaire])
  @@index([id_etudiant])
  @@index([semestre, annee_scolaire])
  @@index([envoye])
  @@map("grade_reports")
}

//////////////////////////////////////
// EVENTS & NEWS SYSTEM
//////////////////////////////////////

// Events (Formations, News, Announcements)
model Evenement {
  id          String    @id @default(cuid())
  titre       String    // Event title
  type        String    // FORMATION, NEWS, ANNOUNCEMENT, EXAM, OTHER
  description String?   @db.Text // Event description
  date        DateTime? // Event date/time
  lieu        String?   // Location
  id_createur String    // Creator (department head)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  creator   Utilisateur      @relation("EventCreator", fields: [id_createur], references: [id], onDelete: Cascade)
  comments  EventComment[]
  reactions EventReaction[]

  @@index([id_createur])
  @@index([type])
  @@index([date])
  @@map("events")
}

// Event Comments
model EventComment {
  id             String   @id @default(cuid())
  id_evenement   String
  id_utilisateur String
  contenu        String   @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  evenement   Evenement   @relation(fields: [id_evenement], references: [id], onDelete: Cascade)
  utilisateur Utilisateur @relation("EventComments", fields: [id_utilisateur], references: [id], onDelete: Cascade)

  @@index([id_evenement])
  @@index([id_utilisateur])
  @@map("event_comments")
}

// Event Reactions
model EventReaction {
  id             String   @id @default(cuid())
  id_evenement   String
  id_utilisateur String
  type           String   // LIKE, LOVE, INTERESTED, GOING, NOT_GOING
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  evenement   Evenement   @relation(fields: [id_evenement], references: [id], onDelete: Cascade)
  utilisateur Utilisateur @relation("EventReactions", fields: [id_utilisateur], references: [id], onDelete: Cascade)

  @@unique([id_evenement, id_utilisateur]) // One reaction per user per event
  @@index([id_evenement])
  @@index([id_utilisateur])
  @@map("event_reactions")
}